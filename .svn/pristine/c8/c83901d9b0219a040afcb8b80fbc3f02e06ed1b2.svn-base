var LazyLoad=function(a,b){this._initialize(a,b);if(this.isFinish()){return}this._initMode();this.resize(true)};LazyLoad.prototype={_initialize:function(a,b){this._elems=a;this._rect={};this._range={};this._loadData=null;this._timer=null;this._lock=false;this._index=0;this._direction=0;this._lastScroll={left:0,top:0};this._setElems=function(){};var c=this._setOptions(b);this.delay=c.delay;this.threshold=c.threshold;this.beforeLoad=c.beforeLoad;this._onLoadData=c.onLoadData;this._container=this._initContainer($$(this.options.container))},_setOptions:function(a){this.options={container:window,mode:"dynamic",threshold:0,delay:100,beforeLoad:function(){},onLoadData:function(){}};return $$.extend(this.options,a||{})},_initContainer:function(b){var f=document,c=b==window||b==f||!b.tagName||(/^(?:body|html)$/i).test(b.tagName);if(c){b=f.compatMode=="CSS1Compat"?f.documentElement:f.body}var d=this,e=0,a=0;this.load=$$F.bind(this._load,this);this.resize=$$F.bind(this._resize,this);this.delayLoad=function(){d._delay(d.load)};this.delayResize=function(){var h=b.clientWidth,g=b.clientHeight;if(h!=e||g!=a){e=h;a=g;d._delay(d.resize)}};this._binder=c?window:b;$$E.addEvent(this._binder,"scroll",this.delayLoad);c&&$$E.addEvent(this._binder,"resize",this.delayResize);this._getContainerRect=c&&("innerHeight" in window)?function(){return{left:0,right:window.innerWidth,top:0,bottom:window.innerHeight}}:function(){return d._getRect(b)};this._getScroll=c?function(){return{left:$$D.getScrollLeft(),top:$$D.getScrollTop()}}:function(){return{left:b.scrollLeft,top:b.scrollTop}};return b},_initMode:function(){switch(this.options.mode.toLowerCase()){case"vertical":this._initStatic("vertical","vertical");break;case"horizontal":this._initStatic("horizontal","horizontal");break;case"cross":case"cross-vertical":this._initStatic("cross","vertical");break;case"cross-horizontal":this._initStatic("cross","horizontal");break;case"dynamic":default:this._loadData=this._loadDynamic}},_initStatic:function(d,b){var c=b=="vertical";if(d=="cross"){this._crossDirection=$$F.bind(this._getCrossDirection,this,c?"_verticalDirection":"_horizontalDirection",c?"_horizontalDirection":"_verticalDirection")}var f=c?"top":"left",a=function(g,h){return g._rect[f]-h._rect[f]},e=function(g){g._rect=this._getRect(g);return g};this._setElems=function(){this._elems=$$A.map(this._elems,e,this).sort(a)};this._loadData=$$F.bind(this._loadStatic,this,"_"+d+"Direction",$$F.bind(this._outofRange,this,d,"_"+b+"BeforeRange"),$$F.bind(this._outofRange,this,d,"_"+b+"AfterRange"))},_delay:function(c){clearTimeout(this._timer);if(this.isFinish()){return}var b=this,a=this.delay;if(this._lock){this._timer=setTimeout(function(){b._delay(c)},a)}else{this._lock=true;c();setTimeout(function(){b._lock=false},a)}},_resize:function(a){if(this.isFinish()){return}this._rect=this._getContainerRect();if(a){this._setElems()}this._load(true)},_load:function(d){if(this.isFinish()){return}var c=this._rect,b=this._getScroll(),f=b.left,e=b.top,a=Math.max(0,this.threshold|0);this._range={top:c.top+e-a,bottom:c.bottom+e+a,left:c.left+f-a,right:c.right+f+a};this.beforeLoad();this._loadData(d)},_loadDynamic:function(){this._elems=$$A.filter(this._elems,function(a){return !this._insideRange(a)},this)},_loadStatic:function(j,d,c,b){j=this[j](b);if(!j){return}var a=this._elems,g=this._index,e=[],k=[],f=[];if(j>0){e=a.slice(0,g);for(var h=a.length;g<h;g++){if(c(k,a[g])){f=a.slice(g+1);break}}g=e.length+k.length-1}else{f=a.slice(g+1);for(;g>=0;g--){if(d(k,a[g])){e=a.slice(0,g);break}}k.reverse()}this._index=Math.max(0,g);this._elems=e.concat(k,f)},_verticalDirection:function(a){return this._getDirection(a,"top")},_horizontalDirection:function(a){return this._getDirection(a,"left")},_getDirection:function(e,a){var c=this._getScroll()[a],d=this._lastScroll;if(e){d[a]=c;this._index=0;return 1}var b=d[a];d[a]=c;return c-b},_getCrossDirection:function(b,a,c){var d;if(!c){d=this[b]();a=this[a]();if(!d&&!a){return 0}else{if(!d){if(this._direction){d=-this._direction}else{c=true}}else{if(a&&d*this._direction>=0){c=true}}}}if(c){this._lastScroll=this._getScroll();this._index=0;d=1}return(this._direction=d)},_insideRange:function(f,g){var b=this._range,e=f._rect||this._getRect(f),d=e.right>=b.left&&e.left<=b.right,c=e.bottom>=b.top&&e.top<=b.bottom,a={horizontal:d,vertical:c,cross:d&&c}[g||"cross"];if(f.src){this._onLoadData(f)}return f.src},_outofRange:function(d,c,a,b){if(!this._insideRange(b,d)){a.push(b);return this[c](b._rect)}},_horizontalBeforeRange:function(a){return a.right<this._range.left},_horizontalAfterRange:function(a){return a.left>this._range.right},_verticalBeforeRange:function(a){return a.bottom<this._range.top},_verticalAfterRange:function(a){return a.top>this._range.bottom},_getRect:function(a){var d=a,c=0,b=0;while(d){c+=d.offsetLeft;b+=d.offsetTop;d=d.offsetParent}return{left:c,right:c+a.offsetWidth,top:b,bottom:b+a.offsetHeight}},isFinish:function(){if(!this._elems||!this._elems.length){this.dispose();return true}else{return false}},dispose:function(a){clearTimeout(this._timer);if(this._elems||this._binder){if(a&&this._elems){$$A.forEach(this._elems,this._onLoadData,this)}$$E.removeEvent(this._binder,"scroll",this.delayLoad);$$E.removeEvent(this._binder,"resize",this.delayResize);this._elems=this._binder=null}}};var ImagesLazyLoad=$$.wrapper(function(a){this._initialize(a);if(this.isFinish()){return}this._initMode();this.resize(true)},LazyLoad);$$.extend(ImagesLazyLoad.prototype,{_initialize:function(a){LazyLoad.prototype._initialize.call(this,[],a);var b=this.options;this.onLoad=b.onLoad;var d=this._attribute=b.attribute;var e=b.getSrc,c=$$F.bind(this._filter,this,b["class"],e?function(f){return e(f)}:function(f){return f.getAttribute(d)||f.src},b.holder);this._elems=$$A.filter(b.images||this._container.getElementsByTagName("img"),c);this._hasAttribute=$$B.ie6||$$B.ie7?function(f){return d in f}:function(f){return f.hasAttribute(d)}},_setOptions:function(a){return LazyLoad.prototype._setOptions.call(this,$$.extend({images:undefined,attribute:"_lazysrc",holder:"","class":"",getSrc:undefined,onLoad:function(){}},$$.extend(a,{onLoadData:this._onLoadData})))},_filter:function(c,d,b,a){if(c&&(" "+a.className+" ").indexOf(" "+c+" ")==-1){return false}var e=d(a);if(!e){return false}if(e==a.src){if(a.complete||$$B.chrome||$$B.safari){return false}a.removeAttribute("src")}if(b&&e.substring(0,4)==="http"){a.src=b}a.setAttribute(this._attribute,e);return true},_onLoadData:function(a){var c=this._attribute;var b=a.getAttribute(c);if(this._hasAttribute(a)&&b.substring(0,4)==="http"){a.src=b;a.removeAttribute(c);this.onLoad(a)}}});
